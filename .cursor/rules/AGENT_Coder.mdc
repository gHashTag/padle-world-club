---
description:
globs:
alwaysApply: false
---
# üßë‚Äçüíª AGENT_Coder: –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–¥–∞

## üìù –†–æ–ª—å –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å

–ê–≥–µ–Ω—Ç-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥–æ—Ç–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π. –ö–ª—é—á–µ–≤—ã–µ –∑–∞–¥–∞—á–∏:

1. –ù–∞–ø–∏—Å–∞–Ω–∏–µ –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã
2. –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–º –ø—Ä–∏–Ω—Ü–∏–ø–∞–º –ø—Ä–æ–µ–∫—Ç–∞
3. –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∫–æ–¥–∞
4. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
5. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫–æ–¥–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞

## üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥
- –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π —á–∏—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–ª–∞—Å—Å–∞–º
- –ò–∑–±–µ–≥–∞–π –º—É—Ç–∞—Ü–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–ø–æ–∑–∏—Ü–∏—é —Ñ—É–Ω–∫—Ü–∏–π

### –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è
- –í—Å–µ–≥–¥–∞ –æ–ø—Ä–µ–¥–µ–ª—è–π —Ç–∏–ø—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π, –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
- –ò–∑–±–µ–≥–∞–π `any` –∏ `unknown`, –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–∏–ø—ã

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏
- –õ–æ–≥–∏—Ä—É–π –æ—à–∏–±–∫–∏ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

### –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–π JSDoc –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π –∏ –∫–ª–∞—Å—Å–æ–≤
- –î–æ–±–∞–≤–ª—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Å–ª–æ–∂–Ω—ã–º —É—á–∞—Å—Ç–∫–∞–º –∫–æ–¥–∞
- –û–±–Ω–æ–≤–ª—è–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞

## üìã –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏

1. ‚úÖ –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏ —Ç–µ—Å—Ç–æ–≤
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ
3. ‚úÖ –ù–∞–ø–∏—Å–∞–Ω–∏–µ –∫–æ–¥–∞, –ø—Ä–æ—Ö–æ–¥—è—â–µ–≥–æ —Ç–µ—Å—Ç—ã
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ (`bun run typecheck`)
5. ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∏ —É–ª—É—á—à–µ–Ω–∏–µ –∫–æ–¥–∞
6. ‚úÖ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –∏ —Ç–µ—Å—Ç–æ–≤

## üß† –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã

```mermaid
graph TD
    A[–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏ —Ç–µ—Å—Ç–æ–≤] --> B[–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤]
    B --> C[–ù–∞–ø–∏—Å–∞–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤]
    C --> D{–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤}
    D -->|–û—à–∏–±–∫–∏| C
    D -->|–£—Å–ø–µ—Ö| E[–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤]
    E -->|–ù–µ –ø—Ä–æ—Ö–æ–¥—è—Ç| C
    E -->|–ü—Ä–æ—Ö–æ–¥—è—Ç| F[–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∏ —É–ª—É—á—à–µ–Ω–∏–µ]
    F --> D
```

## üìö –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

### –§—É–Ω–∫—Ü–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π

```typescript
/**
 * –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID –∏–∑ Telegram
 * @param telegramId ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
 * @returns –ü—Ä–æ–º–∏—Å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏–ª–∏ null, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
 */
export async function getUserByTelegramId(telegramId: number): Promise<User | null> {
  try {
    const user = await db.query.users.findFirst({
      where: eq(users.telegram_id, String(telegramId))
    });
    return user;
  } catch (error) {
    logger.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", {
      error: error instanceof Error ? error : new Error(String(error)),
      type: LogType.ERROR,
      data: { telegramId }
    });
    return null;
  }
}
```

### –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è Wizard-—Å—Ü–µ–Ω—ã

```typescript
/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Wizard-—Å—Ü–µ–Ω–µ
 * @param ctx –ö–æ–Ω—Ç–µ–∫—Å—Ç Telegram
 * @returns –ü—Ä–æ–º–∏—Å, –ø–µ—Ä–µ—Ö–æ–¥—è—â–∏–π –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É –∏–ª–∏ –æ—Å—Ç–∞—é—â–∏–π—Å—è –Ω–∞ —Ç–µ–∫—É—â–µ–º
 */
export const handleNameInput = async (ctx: BaseBotContext): Promise<number | void> => {
  if (!ctx.message || !("text" in ctx.message)) {
    await ctx.reply("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è —Ç–µ–∫—Å—Ç–æ–º");
    return;
  }

  const name = ctx.message.text.trim();
  if (name.length < 2) {
    await ctx.reply("–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞");
    return;
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  const state = ctx.wizard.state as WizardState;
  state.name = name;

  logger.info(`–ü–æ–ª—É—á–µ–Ω–æ –∏–º—è: ${name}`, {
    type: LogType.USER_ACTION,
    userId: ctx.from?.id
  });

  await ctx.reply(`–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, ${name}! –ß—Ç–æ —è –º–æ–≥—É –¥–ª—è –≤–∞—Å —Å–¥–µ–ª–∞—Ç—å?`);
  return ctx.wizard.next();
};
```

### –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö (Drizzle)

```typescript
/**
 * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @param userData –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @returns –°–æ–∑–¥–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
 */
export async function createUser(userData: CreateUserInput): Promise<User> {
  const result = await db.insert(users).values({
    telegram_id: String(userData.telegramId),
    username: userData.username,
    first_name: userData.firstName,
    last_name: userData.lastName
  }).returning();

  return result[0];
}
```

## üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

- `bun run typecheck` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ TypeScript
- `bun run test` - –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
- `bun run tdd` - TDD-—Ü–∏–∫–ª –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- `bun run lint` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ ESLint

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

1. **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** - –ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —Ç–µ—Å—Ç—ã
2. **–¢–∏–ø–∏–∑–∞—Ü–∏—è** - –í—Å–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
3. **–ß–∏—Å—Ç–æ—Ç–∞** - –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å—Ç—ã–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º
4. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–∑–±–∏—Ç –Ω–∞ –º–æ–¥—É–ª–∏
5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω
6. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –í—Å–µ –æ—à–∏–±–∫–∏ –¥–æ–ª–∂–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è
7. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω
