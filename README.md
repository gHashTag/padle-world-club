# Instagram Scraper Bot Module для Telegram

Модуль для Telegram бота, предоставляющий функциональность для управления скрапингом Instagram Reels в нише эстетической медицины.

## Особенности

- Поиск и отслеживание Instagram Reels по аккаунтам конкурентов и хэштегам
- Фильтрация контента по просмотрам (≥ 50,000) и дате публикации (≤ 14 дней)
- Управление проектами, конкурентами и хэштегами через Telegram интерфейс
- Просмотр результатов скрапинга

## Архитектура модуля

Модуль разработан с учетом принципов инкапсуляции и изоляции. Вся бизнес-логика и зависимости находятся внутри модуля, который предоставляет простой API для интеграции с основным Telegram ботом.

### Основные компоненты

- **Сцены** (`/scenes`) - компоненты Telegraf для взаимодействия с пользователем:
  - `project-scene.ts`: Управление проектами (просмотр, создание).
  - `competitor-scene.ts`: Управление конкурентами (просмотр, добавление) в рамках выбранного проекта.
  - `components/`: Переиспользуемые UI-компоненты для клавиатур.
- **Хранилище/Адаптеры** (`/adapters`) - адаптеры для работы с базами данных. Основной адаптер `NeonAdapter` (`/adapters/neon-adapter.ts`) обеспечивает взаимодействие с Neon DB и интегрирован в сцены управления проектами и конкурентами.
- **Агент** (`/agent`) - логика скрапинга Instagram (через Apify)
- **Типы** (`/types`) - TypeScript интерфейсы и типы
- **Скрипты** (`/scripts`) - утилиты для разработки и тестирования

## Использование

```typescript
import { createInstagramScraperBot } from "./modules/instagram-scraper-bot";
import { Telegraf } from "telegraf";

const bot = new Telegraf(process.env.BOT_TOKEN);

// Создаем инстанс модуля с настройками
const scraperBot = createInstagramScraperBot({
  neonDatabaseUrl: process.env.NEON_DATABASE_URL,
  apifyToken: process.env.APIFY_TOKEN,
  minViews: 50000,
  maxAgeDays: 14,
});

// Регистрируем middleware модуля в боте
bot.use(scraperBot);

// Запускаем бота
bot.launch();
```

### Пользовательский Интерфейс (Сцены)

Взаимодействие с модулем происходит через команды Telegram:

- `/projects`: Запускает сцену `projectScene`, где пользователь может:
  - Просмотреть список своих проектов.
  - Создать новый проект, введя его название.
  - Выбрать существующий проект для дальнейших действий (пока не реализовано полностью).
- `/competitors`: Запускает сцену `competitorScene`, где пользователь может:
  - Выбрать проект (если их несколько).
  - Просмотреть список конкурентов для выбранного проекта.
  - Добавить нового конкурента, введя URL его Instagram-профиля.

## Локальная разработка

Для удобства автономной разработки модуль поддерживает несколько режимов работы и инструментов:

### 1. Настройка локальной базы данных SQLite

Модуль поддерживает работу с SQLite для локальной разработки:

```bash
# Инициализация SQLite базы данных с тестовыми данными
bun run scripts/init-dev-db.ts

# Сброс и повторная инициализация базы данных
RESET_DB=true bun run scripts/init-dev-db.ts

# Для использования SQLite установите переменную окружения
export NEON_DATABASE_URL=sqlite:///.dev/sqlite.db
```

### 2. Мокирование Apify API

Модуль предоставляет мок-сервис для Apify API для тестирования без реальных запросов:

```typescript
import { mockScrapeInstagramReels } from "./__tests__/mocks/apify-mock";

// Использование мок-функции для тестирования
const reels = await mockScrapeInstagramReels(
  "https://www.instagram.com/competitor1",
  {
    apifyToken: "test_token",
    minViews: 50000,
    maxAgeDays: 14,
  }
);
```

### 3. Автоматизированное тестирование

```bash
# Запуск всех тестов
bun run scripts/build-and-test.sh

# Компиляция и сборка модуля
bun run build

# Запуск интеграционных тестов с моками внешних зависимостей
bash scripts/test-integration.sh

# Запуск тестов для Telegram-сцен
bash scripts/test-telegram-scenes.sh
```

#### Документация по тестированию

Для разработчиков доступна подробная документация по тестированию:

- [Общая документация по тестированию](./src/__tests__/README.md) - структура тестов, инструменты, команды и паттерны
- [Паттерны тестирования Telegram-сцен](./src/__tests__/TESTING_PATTERNS.md) - подробное описание паттернов тестирования сцен
- [Фреймворк для тестирования Telegram-сцен](./src/__tests__/helpers/telegram/README.md) - документация по фреймворку для тестирования сцен
- [E2E тестирование Telegram-бота](./src/__tests__/E2E_TESTING.md) - подробное описание подхода к E2E тестированию

## Настройка окружения

Модуль использует следующие переменные окружения:

```env
# Обязательные переменные
NEON_DATABASE_URL=postgres://username:password@hostname/database
APIFY_TOKEN=your_apify_token

# Опциональные переменные
MIN_VIEWS=50000           # Минимальное количество просмотров для фильтрации (по умолчанию: 50000)
MAX_AGE_DAYS=14           # Максимальный возраст Reels в днях (по умолчанию: 14)
PARSING_LIMIT=100         # Лимит Reels для получения с Apify (по умолчанию: 100)
```

## Диагностика и отладка

Для отладки модуля можно использовать следующие инструменты:

1. **Логирование** - модуль выводит информацию о важных событиях в консоль
2. **SQLite** - для проверки локальной базы данных можно использовать любой SQLite браузер
3. **Мок API** - для тестирования без внешних зависимостей

## Подробная документация для разработчиков

Для разработчиков модуля доступна [подробная документация](./DEVELOPMENT.md), содержащая:

- Детальное описание архитектуры
- Руководство по автономной разработке
- Примеры использования инструментов разработки
- Советы по отладке и решению частых проблем

### Документация по тестированию

- [Общая документация по тестированию](./src/__tests__/README.md) - структура тестов, инструменты, команды и паттерны
- [Паттерны тестирования Telegram-сцен](./src/__tests__/TESTING_PATTERNS.md) - подробное описание паттернов тестирования сцен
- [Фреймворк для тестирования Telegram-сцен](./src/__tests__/helpers/telegram/README.md) - документация по фреймворку для тестирования сцен

### Документация по паттернам разработки

- [Паттерны для Wizard-сцен](./docs/WIZARD_SCENE_PATTERNS.md) - подробное описание паттернов для создания и поддержки Wizard-сцен
- [Архитектура Wizard-сцен](./docs/WIZARD_SCENE_ARCHITECTURE.md) - описание архитектуры Wizard-сцен после рефакторинга
- [История успеха с Wizard-сценами](./docs/SUCCESS_HISTORY_WIZARD_SCENES.md) - примеры решения конкретных проблем с Wizard-сценами
- [Чек-лист для рефакторинга Wizard-сцен](./docs/WIZARD_SCENE_REFACTORING_CHECKLIST.md) - пошаговый чек-лист для рефакторинга существующих Wizard-сцен

## Будущие улучшения для автономной разработки

Вот несколько предложений для дальнейшего улучшения автономной разработки модуля:

1. **Docker-контейнер для разработки**

   - Создание Dockerfile и docker-compose.yml с полной средой разработки
   - Интеграция SQLite и мок-сервисов в контейнер
   - Автоматическая инициализация тестовой среды при запуске

2. **Специализированный CLI-инструмент**

   - Разработка CLI-утилиты для управления разработкой
   - Команды для генерации шаблонов тестов, сцен и адаптеров
   - Автоматический запуск тестов при изменениях в коде

3. **Интерактивная документация API**

   - Генерация документации API на основе TypeScript типов
   - Веб-интерфейс для просмотра и тестирования API
   - Автоматическое обновление при изменениях

4. **Система мониторинга и профилирования**

   - Инструменты для отслеживания производительности
   - Визуализация узких мест в коде
   - Автоматические рекомендации по оптимизации

5. **Расширенное мокирование Instagram API**
   - Более реалистичные данные из Instagram
   - Симуляция различных ошибок и граничных случаев
   - Настраиваемые сценарии тестирования

## License

MIT
