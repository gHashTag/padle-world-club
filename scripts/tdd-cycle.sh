#!/bin/bash

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN="\033[0;32m"
YELLOW="\033[0;33m"
RED="\033[0;31m"
BLUE="\033[0;34m"
NC="\033[0m" # No Color

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
if [ $# -eq 0 ]; then
  echo -e "${RED}–û—à–∏–±–∫–∞: –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ —Ç–µ—Å—Ç–æ–≤–æ–º—É —Ñ–∞–π–ª—É.${NC}"
  echo -e "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <–ø—É—Ç—å_–∫_—Ç–µ—Å—Ç–æ–≤–æ–º—É_—Ñ–∞–π–ª—É>"
  echo -e "–ü—Ä–∏–º–µ—Ä: $0 src/__tests__/unit/scenes/project-scene-enter.test.ts"
  exit 1
fi

TEST_FILE=$1

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
if [ ! -f "$TEST_FILE" ]; then
  echo -e "${RED}–û—à–∏–±–∫–∞: –§–∞–π–ª $TEST_FILE –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.${NC}"
  exit 1
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤
check_types() {
  echo -e "${BLUE}üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤...${NC}"
  bun run typecheck
  if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.${NC}"
    return 1
  fi
  echo -e "${GREEN}‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.${NC}"
  return 0
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
run_test() {
  echo -e "${BLUE}üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ $TEST_FILE...${NC}"
  bun test "$TEST_FILE"
  return $?
}

# –®–∞–≥ 1: –ö—Ä–∞—Å–Ω—ã–π (Red) - —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–µ—Å—Ç –ø–∞–¥–∞–µ—Ç
echo -e "${RED}üî¥ –®–∞–≥ 1: –ö—Ä–∞—Å–Ω—ã–π (Red) - —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–µ—Å—Ç –ø–∞–¥–∞–µ—Ç${NC}"
check_types
if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å TDD-—Ü–∏–∫–ª. –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ —Ç–∏–ø–æ–≤.${NC}"
  exit 1
fi

run_test
TEST_RESULT=$?

if [ $TEST_RESULT -eq 0 ]; then
  echo -e "${YELLOW}‚ö†Ô∏è –¢–µ—Å—Ç —É–∂–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç. –î–ª—è TDD-—Ü–∏–∫–ª–∞ —Ç–µ—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–Ω–∞—á–∞–ª–∞ –ø–∞–¥–∞—Ç—å.${NC}"
  echo -e "${YELLOW}‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏–ª–∏ —Ç–µ—Å—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞–Ω.${NC}"
  
  read -p "–•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å TDD-—Ü–∏–∫–ª? (y/n): " CONTINUE
  if [[ $CONTINUE != "y" && $CONTINUE != "Y" ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è TDD-—Ü–∏–∫–ª –ø—Ä–µ—Ä–≤–∞–Ω.${NC}"
    exit 0
  fi
else
  echo -e "${GREEN}‚úÖ –¢–µ—Å—Ç –ø–∞–¥–∞–µ—Ç, –∫–∞–∫ –∏ –æ–∂–∏–¥–∞–ª–æ—Å—å. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É.${NC}"
fi

# –®–∞–≥ 2: –ó–µ–ª–µ–Ω—ã–π (Green) - —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
echo -e "${GREEN}üü¢ –®–∞–≥ 2: –ó–µ–ª–µ–Ω—ã–π (Green) - —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å${NC}"
echo -e "${YELLOW}‚ö†Ô∏è –ù–∞–ø–∏—à–∏—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–¥, —á—Ç–æ–±—ã —Ç–µ—Å—Ç –ø—Ä–æ—à–µ–ª.${NC}"
echo -e "${YELLOW}‚ö†Ô∏è –ü–æ—Å–ª–µ –Ω–∞–ø–∏—Å–∞–Ω–∏—è –∫–æ–¥–∞ –Ω–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è...${NC}"
read

# –¶–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤ –∏ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ –¥–æ —É—Å–ø–µ—Ö–∞
while true; do
  check_types
  if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏...${NC}"
    read
    continue
  fi

  run_test
  TEST_RESULT=$?

  if [ $TEST_RESULT -ne 0 ]; then
    echo -e "${RED}‚ùå –¢–µ—Å—Ç –≤—Å–µ –µ—â–µ –ø–∞–¥–∞–µ—Ç. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏...${NC}"
    read
    continue
  fi

  echo -e "${GREEN}‚úÖ –¢–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É.${NC}"
  break
done

# –®–∞–≥ 3: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ (Refactor) - —É–ª—É—á—à–∏—Ç—å –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
echo -e "${BLUE}‚ôªÔ∏è –®–∞–≥ 3: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ (Refactor) - —É–ª—É—á—à–∏—Ç–µ –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏${NC}"
echo -e "${YELLOW}‚ö†Ô∏è –£–ª—É—á—à–∏—Ç–µ –∫–æ–¥, —Å–æ—Ö—Ä–∞–Ω—è—è –µ–≥–æ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å.${NC}"
echo -e "${YELLOW}‚ö†Ô∏è –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è...${NC}"
read

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ —Ç–µ—Å—Ç—ã –≤—Å–µ –µ—â–µ –ø—Ä–æ—Ö–æ–¥—è—Ç
check_types
if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∑–∞–Ω–æ–≤–æ.${NC}"
  exit 1
fi

run_test
TEST_RESULT=$?

if [ $TEST_RESULT -ne 0 ]; then
  echo -e "${RED}‚ùå –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ —Ç–µ—Å—Ç –ø–∞–¥–∞–µ—Ç. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∑–∞–Ω–æ–≤–æ.${NC}"
  exit 1
fi

echo -e "${GREEN}‚úÖ –¢–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞!${NC}"
echo -e "${GREEN}‚úÖ TDD-—Ü–∏–∫–ª –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!${NC}"

# –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
echo -e "${YELLOW}‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–ª–æ–º–∞–ª–æ—Å—å.${NC}"
read -p "–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã? (y/n): " RUN_ALL_TESTS
if [[ $RUN_ALL_TESTS == "y" || $RUN_ALL_TESTS == "Y" ]]; then
  echo -e "${BLUE}üß™ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤...${NC}"
  bun test
  if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º.${NC}"
    exit 1
  fi
  echo -e "${GREEN}‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!${NC}"
fi

echo -e "${GREEN}üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ TDD-—Ü–∏–∫–ª!${NC}"
exit 0
