#!/bin/bash

# Скрипт для запуска бота и тестирования в одном процессе

# Цвета для вывода
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Запуск бота и тестирования в одном процессе...${NC}"

# Проверка наличия необходимых зависимостей
echo -e "${YELLOW}Проверка наличия необходимых зависимостей...${NC}"
if ! command -v bun &> /dev/null; then
    echo -e "${RED}Ошибка: bun не установлен. Установите bun для запуска скрипта.${NC}"
    exit 1
fi

# Установка зависимостей, если они не установлены
echo -e "${YELLOW}Установка зависимостей...${NC}"
bun install

# Запуск бота в фоновом режиме
echo -e "${YELLOW}Запуск бота в фоновом режиме...${NC}"
bun run src/bot.ts &
BOT_PID=$!

# Ожидание запуска бота
echo -e "${YELLOW}Ожидание запуска бота (10 секунд)...${NC}"
sleep 10

# Запуск тестирования
echo -e "${YELLOW}Запуск тестирования...${NC}"
bun run scripts/test-bot-flow.ts

# Получение статуса выполнения тестирования
TEST_STATUS=$?

# Остановка бота
echo -e "${YELLOW}Остановка бота...${NC}"
kill $BOT_PID

# Ожидание завершения процесса бота
wait $BOT_PID 2>/dev/null
BOT_STATUS=$?

# Вывод результатов
if [ $TEST_STATUS -eq 0 ] && [ $BOT_STATUS -eq 0 ]; then
    echo -e "${GREEN}Тестирование успешно завершено.${NC}"
    exit 0
else
    echo -e "${RED}Тестирование завершено с ошибками.${NC}"
    exit 1
fi
