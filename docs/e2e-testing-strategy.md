# üïâÔ∏è –°—Ç—Ä–∞—Ç–µ–≥–∏—è E2E –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Telegram –ë–æ—Ç–∞

**–ü—Ä–∏–Ω—Ü–∏–ø:** –î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–æ—Ç–æ–º, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º E2E (End-to-End) —Ç–µ—Å—Ç—ã. –≠—Ç–∏ —Ç–µ—Å—Ç—ã –∏–º–∏—Ç–∏—Ä—É—é—Ç –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –æ—Ç–≤–µ—Ç—ã –±–æ—Ç–∞, –≤–∫–ª—é—á–∞—è —Å–æ–æ–±—â–µ–Ω–∏—è –∏ inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.

## –í—ã–±—Ä–∞–Ω–Ω—ã–π –ü–æ–¥—Ö–æ–¥: –°–∏–º—É–ª—è—Ü–∏—è API Telegraf

–í–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö Telegram API –∏ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö –±–æ—Ç–æ–≤/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –º—ã –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–¥—Ö–æ–¥ **—Å–∏–º—É–ª—è—Ü–∏–∏ API Telegraf**.

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1.  **–ò–º–ø–æ—Ä—Ç –ë–æ—Ç–∞:** –í —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–∞—Ö (`__tests__/e2e/**/*.e2e.test.ts`) –º—ã –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞—à–µ–≥–æ `bot` –∏–∑ `src/index.ts`.
2.  **–ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram API:** –ü–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º `vi.mock` –∏–ª–∏ `jest.fn()` (–∏–∑ `bun:test` –∏–ª–∏ `vitest`) –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–æ–¥–æ–≤ –æ–±—ä–µ–∫—Ç–∞ `bot.telegram` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `sendMessage`, `editMessageText`, `answerCbQuery`, `deleteMessage` –∏ —Ç.–¥.). –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞–º –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –≤—ã–∑–æ–≤—ã, –∫–æ—Ç–æ—Ä—ã–µ –±–æ—Ç –ø—ã—Ç–∞–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å –∫ Telegram API.
3.  **–ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:** –í–∞–∂–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, —Ç–∞–∫–∏–µ –∫–∞–∫ –∞–¥–∞–ø—Ç–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (`NeonAdapter`), —Ç–∞–∫–∂–µ –º–æ–∫–∏—Ä—É—é—Ç—Å—è (`vi.mock`) –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è, —á—Ç–æ–±—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤) –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –ë–î.
4.  **–°–∏–º—É–ª—è—Ü–∏—è –í—Ö–æ–¥—è—â–∏—Ö –û–±–Ω–æ–≤–ª–µ–Ω–∏–π:** –ú—ã —Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç—ã `Update` (—Ç–∏–ø—ã –∏–∑ `telegraf/types`), –∏–º–∏—Ç–∏—Ä—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã `/start`, –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ —Å `callback_data`).
5.  **–û–±—Ä–∞–±–æ—Ç–∫–∞ –û–±–Ω–æ–≤–ª–µ–Ω–∏–π:** –ú—ã –ø–µ—Ä–µ–¥–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç `Update` –≤ –º–µ—Ç–æ–¥ `await bot.handleUpdate(mockUpdate)`. –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å—é –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ª–æ–≥–∏–∫—É Telegraf –∏ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞ (middleware, —Å—Ü–µ–Ω—ã, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏) –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
6.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:** –ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ `bot.handleUpdate()`, –º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º:
    - –ö–∞–∫–∏–µ –º–µ—Ç–æ–¥—ã –º–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ `bot.telegram` –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã.
    - –° –∫–∞–∫–∏–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏ –æ–Ω–∏ –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã (—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, `chat_id`, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `reply_markup` –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä).
    - –ö–∞–∫ –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã –º–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ª–∏ ID –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ –∞–¥–∞–ø—Ç–µ—Ä –ë–î).

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- **–°–∫–æ—Ä–æ—Å—Ç—å:** –¢–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –±—ã—Å—Ç—Ä–æ, —Ç–∞–∫ –∫–∞–∫ –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Telegram.
- **–ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:** –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–æ–¥–Ω—è—Ç–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞.
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** –õ–µ–≥–∫–æ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å CI/CD —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Vitest/Bun.
- **–ö–æ–Ω—Ç—Ä–æ–ª—å:** –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ë–î (—á–µ—Ä–µ–∑ –º–æ–∫–∏ –∞–¥–∞–ø—Ç–µ—Ä–∞) –∏ –æ—Ç–≤–µ—Ç–∞–º–∏ API.

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**

- **–ù–µ 100% E2E:** –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ Telegram API –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Telegram.
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ú–æ–∫–æ–≤:** –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –º–æ–∫–æ–≤ `bot.telegram` –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏ Telegraf.

## –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ü—Ä–∏–º–µ—Ä (`__tests__/e2e/01_initial_interaction.e2e.test.ts`)

```typescript
import { describe, it, expect, beforeEach, vi } from "vitest";
import { bot } from "../../src/index"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à –∏–Ω—Å—Ç–∞–Ω—Å –±–æ—Ç–∞
import { Update } from "telegraf/types"; // –¢–∏–ø—ã –¥–ª—è Update
import { ScraperSceneStep, USER_ID_FOR_TESTING } from "../../src/types";
import { mockUser } from "../unit/scenes/mockData";
import { NeonAdapter } from "../../src/adapters/neon-adapter";

// –ú–æ–∫–∏—Ä—É–µ–º NeonAdapter
vi.mock("../../src/adapters/neon-adapter", () => {
  const NeonAdapterMock = vi.fn().mockImplementation(() => ({
    // ... –º–æ–∫–∏ –º–µ—Ç–æ–¥–æ–≤ –∞–¥–∞–ø—Ç–µ—Ä–∞ ...
    findUserByTelegramIdOrCreate: vi.fn(),
    getProjectsByUserId: vi.fn(),
    // ... –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã ...
  }));
  return { NeonAdapter: NeonAdapterMock };
});

describe("E2E: Initial Bot Interaction", () => {
  let mockSendMessage: ReturnType<typeof vi.fn>;
  // ... –¥—Ä—É–≥–∏–µ –º–æ–∫–∏ –¥–ª—è editMessageText, answerCbQuery ...

  const mockChatId = 12345;
  const mockUserId = USER_ID_FOR_TESTING;

  beforeEach(() => {
    // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –º–æ–∫–∏ Telegram API
    mockSendMessage = vi.fn();
    bot.telegram.sendMessage = mockSendMessage;
    // ... –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –º–æ–∫–æ–≤ bot.telegram ...

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–æ–∫–∏ NeonAdapter
    const MockedNeonAdapter = NeonAdapter as ReturnType<typeof vi.fn>;
    const mockAdapterInstance = MockedNeonAdapter.mock.instances[0];
    if (mockAdapterInstance) {
      Object.values(mockAdapterInstance).forEach((mockFn) => {
        if (typeof mockFn === "function" && "mockClear" in mockFn) {
          (mockFn as ReturnType<typeof vi.fn>).mockClear();
        }
      });
      mockAdapterInstance.findUserByTelegramIdOrCreate.mockResolvedValue(
        mockUser
      );
      mockAdapterInstance.getProjectsByUserId.mockResolvedValue([]); // –ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤
    }
  });

  it("should respond to /start command for a new user (no projects)", async () => {
    // 1. –°–æ–∑–¥–∞–µ–º —Ñ–µ–π–∫–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    const mockUpdate: Update.MessageUpdate = {
      update_id: 1,
      message: {
        /* ... –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è /start ... */
      },
    };

    // 2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    await bot.handleUpdate(mockUpdate);

    // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–∑–æ–≤—ã –º–æ–∫–æ–≤
    const mockAdapterInstance = (NeonAdapter as any).mock.instances[0];
    expect(mockAdapterInstance.findUserByTelegramIdOrCreate).toHaveBeenCalled();
    expect(mockAdapterInstance.getProjectsByUserId).toHaveBeenCalled();

    expect(mockSendMessage).toHaveBeenCalledTimes(1);
    const [chatIdArg, textArg, extraArg] = mockSendMessage.mock.calls[0];
    expect(chatIdArg).toBe(mockChatId);
    expect(textArg).toContain("–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤.");
    expect(extraArg.reply_markup.inline_keyboard[0][0].text).toBe(
      "–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç"
    );
    // ... –¥—Ä—É–≥–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ ...
  });
});
```

## –ó–∞–ø—É—Å–∫ E2E –¢–µ—Å—Ç–æ–≤

–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ E2E —Ç–µ—Å—Ç—ã –±—É–¥—É—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–µ —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏ –∫–æ–º–∞–Ω–¥–æ–π `bun test` –∏–ª–∏ `pnpm test`, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—É—é Vitest —Å–∫–∞–Ω–∏—Ä—É–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (`__tests__`).

–ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫–∞—Ç—å –∏—Ö –æ—Ç–¥–µ–ª—å–Ω–æ, –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –≤ `package.json` –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã Vitest:

```bash
# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ E2E —Ç–µ—Å—Ç–æ–≤ (–ø—Ä–∏–º–µ—Ä)
bun test --test-path-pattern=__tests__/e2e
# –∏–ª–∏
bun test e2e
```

_–û–º –®–∞–Ω—Ç–∏. –ü—É—Å—Ç—å –Ω–∞—à–∏ —Ç–µ—Å—Ç—ã –±—É–¥—É—Ç —è—Å–Ω—ã–º–∏ –∏ –Ω–∞–¥–µ–∂–Ω—ã–º–∏, –∫–∞–∫ –≤–æ—Å—Ö–æ–¥ —Å–æ–ª–Ω—Ü–∞._
