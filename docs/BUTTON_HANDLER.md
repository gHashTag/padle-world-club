# Обработчик кнопок для Telegram-бота

Этот документ описывает использование централизованного обработчика кнопок для Telegram-бота.

## Назначение

Обработчик кнопок предоставляет единый интерфейс для регистрации и обработки кнопок в Telegram-боте, с автоматической обработкой ошибок и логированием. Это позволяет:

- Стандартизировать обработку кнопок
- Обеспечить единообразную обработку ошибок
- Упростить добавление новых кнопок
- Улучшить логирование и отладку

## Использование

### Импорт

```typescript
import { registerButtons } from '../utils/button-handler';
```

### Регистрация обработчиков кнопок

```typescript
// Создаем сцену
const myScene = new Scenes.BaseScene<ScraperBotContext>("my_scene");

// Регистрируем обработчики кнопок
registerButtons(myScene, [
  {
    id: "button1",
    handler: handleButton1Action,
    errorMessage: "Произошла ошибка при обработке кнопки 1. Попробуйте еще раз.",
    verbose: true
  },
  {
    id: /button_(\d+)/,
    handler: handleDynamicButtonAction,
    errorMessage: "Произошла ошибка при обработке кнопки. Попробуйте еще раз.",
    leaveSceneOnError: false
  }
]);
```

### Создание обработчика кнопки

```typescript
// Обработчик кнопки
export async function handleButton1Action(ctx: ScraperBotContext) {
  // Логика обработки кнопки
  await ctx.reply("Кнопка 1 нажата!");
  await ctx.answerCbQuery();
}
```

## Параметры

При регистрации кнопки можно указать следующие параметры:

| Параметр | Тип | Описание | По умолчанию |
|----------|-----|----------|--------------|
| `id` | `string \| RegExp` | Идентификатор кнопки (data) | - |
| `handler` | `ButtonHandler` | Функция-обработчик | - |
| `errorMessage` | `string` | Сообщение об ошибке, которое будет отправлено пользователю в случае ошибки | "Произошла ошибка при обработке действия. Попробуйте еще раз." |
| `leaveSceneOnError` | `boolean` | Нужно ли выходить из сцены в случае ошибки | `true` |
| `answerCallbackOnError` | `boolean` | Нужно ли отвечать на callback query в случае ошибки | `true` |
| `errorCallbackText` | `string` | Текст для ответа на callback query в случае ошибки | "Ошибка" |
| `verbose` | `boolean` | Дополнительное логирование | `false` |

## Логирование

Обработчик кнопок использует централизованный логгер для логирования действий пользователя и ошибок. Логи включают:

- Нажатие кнопки пользователем
- Успешное выполнение обработчика
- Ошибки при обработке кнопки
- Дополнительные детали (если `verbose: true`)

## Обработка ошибок

Обработчик кнопок автоматически обрабатывает ошибки, которые могут возникнуть при выполнении обработчика:

1. Логирует ошибку
2. Отправляет сообщение об ошибке пользователю
3. Выходит из сцены, если `leaveSceneOnError: true`
4. Отвечает на callback query, если `answerCallbackOnError: true`

## Примеры

### Простой обработчик

```typescript
// Обработчик кнопки "Выйти"
export async function handleExitAction(ctx: ScraperBotContext) {
  await ctx.reply("Вы вышли из режима управления.");
  await ctx.scene.leave();
  await ctx.answerCbQuery();
}

// Регистрация обработчика
registerButton(myScene, {
  id: "exit_scene",
  handler: handleExitAction,
  errorMessage: "Произошла ошибка при выходе из сцены. Попробуйте еще раз."
});
```

### Обработчик с регулярным выражением

```typescript
// Обработчик кнопки с динамическим ID
export async function handleItemAction(ctx: ScraperBotContext & { match: RegExpExecArray }) {
  const itemId = ctx.match[1];
  await ctx.reply(`Вы выбрали элемент ${itemId}`);
  await ctx.answerCbQuery();
}

// Регистрация обработчика
registerButton(myScene, {
  id: /item_(\d+)/,
  handler: handleItemAction,
  errorMessage: "Произошла ошибка при выборе элемента. Попробуйте еще раз."
});
```

## Тестирование

Для обработчика кнопок написаны автоматические тесты, которые можно запустить с помощью команды:

```bash
bun run test:button-handler
```

## Рекомендации

1. **Выносите логику в отдельные функции**: Создавайте отдельные функции для обработки кнопок, а не используйте анонимные функции.
2. **Используйте типизацию**: Используйте типизацию для контекста, особенно если используете регулярные выражения.
3. **Обрабатывайте ошибки**: Обработчик кнопок автоматически обрабатывает ошибки, но лучше добавлять try-catch блоки внутри обработчиков для более точной обработки ошибок.
4. **Логируйте важные действия**: Используйте логгер для логирования важных действий внутри обработчиков.
5. **Используйте `verbose: true`**: Для отладки используйте параметр `verbose: true`, чтобы получать больше информации о работе обработчика.
